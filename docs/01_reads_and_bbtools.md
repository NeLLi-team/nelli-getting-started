# Read QC and Coverage Profiling with BBTools

## Objectives
- Produce adapter- and quality-trimmed reads suitable for assembly and binning.
- Map reads back to the assembly to generate per-contig depth statistics.
- Learn how to simulate small datasets locally when you cannot download real data.

All commands below are wrapped in `scripts/qc_map.sh` so you can rerun the full sequence with minimal typing.

## 1. Quality Control (bbduk)

```bash
bbduk.sh \
  in=R1.fq.gz in2=R2.fq.gz \
  out1=clean_R1.fq.gz out2=clean_R2.fq.gz \
  ref=adapters ktrim=r k=23 mink=11 hdist=1 tpe tbo qtrim=rl trimq=10
```

- `ktrim=r` trims adapters from the right end; `mink=11` catches short adapter remnants.
- `tpe` / `tbo` keep read pairs synchronised and trims both ends if a match is found in either mate.
- `qtrim=rl trimq=10` performs aggressive end trimming for bases below Q10.
- Output metrics (`stats` file) are logged by the script—inspect them to confirm how many reads were filtered.

## 2. Mapping and Depth Calculation

```bash
bbmap.sh ref=assembly.fna in=clean_R1.fq.gz in2=clean_R2.fq.gz out=mapped.sam fast=t
samtools sort -o mapped.bam mapped.sam
samtools index mapped.bam
jgi_summarize_bam_contig_depths --outputDepth depth.txt mapped.bam
```

- `fast=t` accelerates mapping for small, high-identity assemblies.
- `jgi_summarize_bam_contig_depths` emits contig coverage, length, and GC content—vital inputs for MetaBAT2 and other binners.
- Inspect `depth.txt` to confirm that coverage profiles make sense (contigs originating from the same genome should have similar depths).

## 3. Read Simulation for Offline Practice

Use `randomreads.sh` when you want a synthetic dataset that mirrors our toy example but do not have internet connectivity.

```bash
randomreads.sh \
  ref=assembly.fna \
  out1=R1.fq.gz out2=R2.fq.gz \
  len=150 paired coverage=30 illumina=t
```

- Adjust `coverage` to modulate read depth; 30× gives a comfortably solvable assembly.
- Use `seed=42` for reproducibility.

## 4. Running BBTools via Container

Our helper script checks for native BBTools binaries and falls back to Docker when necessary.

```bash
bash scripts/run_bbtools.sh bbmap.sh --version
```

- Override the container image with `BBTOOLS_IMAGE` if you need a different build.
- The wrapper mounts the current directory so all input/output paths remain relative to the repo root.

## 5. Outputs to Inspect
- `clean_R1.fq.gz`, `clean_R2.fq.gz` — trimmed reads.
- `mapped.bam` plus index — alignments used for coverage profiling.
- `depth.txt` — tabular contig coverage; load it in a spreadsheet or notebook to explore coverage variance.
- `qc_map.log` (generated by the script) — consolidated log with command invocations and run times.

Commit the log to your onboarding notes to demonstrate you can reproduce the QC → depth workflow end-to-end.
